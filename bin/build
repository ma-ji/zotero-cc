#!/bin/sh
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
cd "$ROOT_DIR"

INPUT_VERSION="${1:-${VERSION:-}}"

if command -v python3 >/dev/null 2>&1; then
  MANIFEST_VERSION="$(python3 - <<'PY'
import json
with open("manifest.json", "r", encoding="utf-8") as f:
    data = json.load(f)
version = str(data.get("version", "")).strip()
print(version)
PY
)"
else
  MANIFEST_VERSION="$(grep -E '"version"' manifest.json | head -n1 | sed 's/.*"version": *"\([^"]*\)".*/\1/')"
fi

INPUT_VERSION="$(printf '%s' "${INPUT_VERSION}" | tr -d '[:space:]')"
MANIFEST_VERSION="$(printf '%s' "${MANIFEST_VERSION}" | tr -d '[:space:]')"

if [ -z "${MANIFEST_VERSION}" ]; then
  echo "Error: Unable to determine version from manifest.json" >&2
  exit 1
fi

if [ -n "${INPUT_VERSION}" ]; then
  if [ "${INPUT_VERSION#v}" != "${INPUT_VERSION}" ]; then
    VERSION="${INPUT_VERSION#v}"
  else
    VERSION="${INPUT_VERSION}"
  fi
else
  VERSION="${MANIFEST_VERSION}"
fi

if [ "${VERSION}" != "${MANIFEST_VERSION}" ]; then
  echo "Error: Provided version (${VERSION}) does not match manifest.json version (${MANIFEST_VERSION})." >&2
  echo "Update manifest.json before creating a release, or call this script with the matching version." >&2
  exit 1
fi

if ! command -v zip >/dev/null 2>&1; then
  echo "Error: 'zip' command not found. Install zip before building the package." >&2
  exit 1
fi

DIST_DIR="dist"
ARTIFACT_NAME="zoterocitationcountsmanager-${VERSION}.xpi"

mkdir -p "${DIST_DIR}"
rm -f "${DIST_DIR}/${ARTIFACT_NAME}"

zip -r "${DIST_DIR}/${ARTIFACT_NAME}" \
  locale/* \
  manifest.json \
  bootstrap.js \
  preferences.js \
  preferences.xhtml \
  prefs.js \
  zoterocitationcounts.js >/dev/null

echo "Created ${DIST_DIR}/${ARTIFACT_NAME}"
